# Jenkins构建SpringCloud微服务

## Jenkins+Docker+Cloud持续集成流程说明

![1584794486807](../image/1584794486807.png)

图片很清晰，大概流程为：

1. 开发人员提交代码到gitlab上
2. gitlab的webhook钩子方法远程请求Jenkins进行编译打包
3. Jenkins编译打包后，构建镜像，并上传镜像到Docker仓库中
4. 这里使用Harbor做镜像仓库
5. Jenkins上传完毕删除镜像，并远程请求生产服务器进行部署
6. 生产服务器首先删除原来的镜像，然后从Docker拉取新镜像
7. 创建容器后，用户即可访问

**服务列表**（黑色为已经安装，红色未安装）

| 名称             | IP             | 所需软件                                                     |
| ---------------- | -------------- | ------------------------------------------------------------ |
| 代码托管服务器   | 192.168.56.130 | Gitlab-12.4.2 （最好2G以上内存）                             |
| 持续集成服务器   | 192.168.56.131 | Jenkins-2.190.3，JDK1.8，Maven3.6.2，Git，Sonar，<font color=ff0000>Docker18.06.1-ce</font> |
| Docker仓库服务器 | 192.168.56.132 | <font color=ff0000>Docker18.06.1-ce</font>，<font color=ff0000>Harbor1.9.2</font> |
| 生产部署服务器   | 192.168.56.133 | <font color=ff0000>Docker18.06.1-ce</font>                   |

## 本地部署SpringCloud微服务

这里我使用之前学成在线的项目，但是是简化版，项目地址为：

### SpringCloud微服务简介

前后端分离项目，后端使用：SpringBoot，SpringCloud，SpringDataJPA，Mybatis

微服务项目结构：

![1584804107934](../image/1584804107934.png)

- xc-framework-common：公共类
- xc-framework-model：实体类
- xc-framework-utils：工具类
- xc-govern-center：注册中心服务
- xc-govern-gateway：zuul服务网关
- xc-service-manage-course：课程服务

这里我们主要部署的为注册中心，zuul和课程服务

### SpringCloud微服务部署

#### 本地运行微服务

本地运行前，**我们需要向数据库执行sql脚本**，保存在mysql文件夹下

依次执行xc-govern-center => xc-govern-gateway => xc-service-manage-course

使用postman测试请求：查询课程基本

```
POST 127.0.0.1:50201/api/course/coursepic/get/297e7c7c62b888f00162b8a7dec20000
```

![1584804419433](../image/1584804419433.png)

**注意！我们配置的Zuul网关规则是必须带有请求头，并且键为Authorization，值以`Bearer `开头，有个空格哦**

#### 本地部署微服务

1）打包

![1584804533129](../image/1584804533129.png)

在命令行窗口中输入`mvn clean package`

![1584804592430](../image/1584804592430.png)

打包完毕会看到target目录下有个jar包

2）部署

cmd中输入`java -jar xc-govern-center.jar`

![1584804648150](../image/1584804648150.png)

![1584804689198](../image/1584804689198.png)

运行成功，并且可以访问

![1584804711409](../image/1584804711409.png)

说明部署成功



